# Default values for complex-k8s.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

worker:
  enabled: true
  image: aleksaspielikis/multi-worker

client:
  enabled: true
  replicas: 3
  image: aleksaspielikis/multi-client

server:
  enabled: true
  replicas: 3
  image: aleksaspielikis/multi-server

redis:
  enabled: true
  clusterPort: 6379

metricbeat:
  enabled: true
  metricbeatConfig:
    kube-state-metrics-metricbeat.yml: |
      metricbeat.modules:
      - module: kubernetes
        enabled: true
        metricsets:
          - state_node
          - state_deployment
          - state_replicaset
          - state_pod
          - state_container
        period: 10s
        hosts: ["${KUBE_STATE_METRICS_HOSTS}"]

      output.elasticsearch:
        hosts: '${ELASTICSEARCH_HOSTS:elasticsearch-master:9200}'

      setup:
        kibana:
          host: '${KIBANA_HOST:my-release-kibana}:${KIBANA_PORT:5601}'
        dashboards:
          enabled: true
    metricbeat.yml: |
      system:
        hostfs: /hostfs
      metricbeat.autodiscover: #https://www.elastic.co/guide/en/beats/metricbeat/current/configuration-autodiscover.html
        providers:
        - type: kubernetes
          labels.dedot: true
          templates:
            - condition:
                contains:
                  kubernetes.container.image: "redis"
              config:
                - module: redis
                  metricsets: ["info", "keyspace"]
                  hosts: "${data.host}:6379"
                  period: 10s
      output.elasticsearch:
        hosts: '${ELASTICSEARCH_HOSTS:elasticsearch-master:9200}'

filebeat:
  enabled: true
  filebeatConfig:
    filebeat.yml: |-
      filebeat.autodiscover:
        providers:
          - type: kubernetes
            host: ${NODE_NAME}
            hints.enabled: true
            hints.default_config:
              type: container
              paths:
                - /var/log/containers/*${data.kubernetes.container.id}.log
            templates:
              - condition:
                  contains:
                    kubernetes.container.image: redis
                config:
                  - module: redis
                    log:
                      input:
                        type: container
                        containers.ids:
                          - ${data.kubernetes.container.id}
                    slowlog:
                      input:
                        type: container
                        containers.ids:
                          - ${data.kubernetes.container.id}
                          
      processors:
        - add_host_metadata:
        
      output.elasticsearch:
        host: '${NODE_NAME}'
        hosts: '${ELASTICSEARCH_HOSTS:elasticsearch-master:9200}'

      setup:
        kibana:
          host: '${KIBANA_HOST:my-release-kibana}:${KIBANA_PORT:5601}'
        dashboards:
          enabled: true

kibana:
  enabled: true
  server:
    basePath: /kibana
    rewriteBasePath: true
  extraEnvs:
  - name: SERVER_BASEPATH
    value: /kibana

elasticsearch:
  enabled: true
  antiAffinity: "soft"
  
  volumeClaimTemplate:
    resources:
      requests:
        storage: 10Gi

postgres:
  enabled: true
  clusterPort: 5432
  storage: 2Gi
  secretKeyRef:
    name: pgpassword
    key: PGPASSWORD

ingress:
  enabled: true
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /$1    
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^/kibana/?(.*)$ /$1 break;
      proxy_set_header Authorization "";
  expose:
    client:
      path: /?(.*)
      clusterPort: 3000
    kibana:
      path: /kibana/?(.*)
      clusterPort: 5601
    server:
      path: /api/?(.*)
      clusterPort: 5000
